---
layout: single
title: Random Walk for 3SAT — Markov Chain Demo
permalink: "/teaching/3sat-random-walk/"
katex: false
author_profile: false
---

<style>
:root{
  /* light by default */
  --bg: #f6f8ff;
  --panel: #ffffff;
  --muted: #5b6477;
  --text: #0c1020;
  --accent: #2c6dff;
  --accent-2:#1a936f;
  --good: #1f8a4c;
  --bad:  #c0392b;
  --warn: #b8860b;
  --chip: #f3f6ff;
  --chip-border: #e4e9ff;
  --ring: rgba(44,109,255,.18);
  --shadow: 0 10px 30px rgba(0,0,0,.12);
}

@media (prefers-color-scheme: dark){
  :root{
    --bg: #0b0d12;
    --panel: #121621;
    --muted: #8b93a7;
    --text: #e7ebff;
    --accent: #7aa2ff;
    --accent-2:#9bdeac;
    --good: #2ecc71;
    --bad:  #ff6b6b;
    --warn: #ffd166;
    --chip: #1b2233;
    --chip-border: #2a3347;
    --ring: rgba(122,162,255,.25);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
}

/* Let the demo own the width, but keep it centered like other teaching pages */
.page, .page__inner, .page__inner-wrap, .page__content, .initial-content, .wrap { max-width: none !important; width: 100% !important; }
.wrap { padding-left: 0 !important; padding-right: 0 !important; }
.page { margin: 0 !important; }

/* Hide theme chrome & duplicate title */
.masthead, .page__footer, .page__meta, .author__sidebar, .sidebar, .breadcrumbs, .page__hero { display: none !important; }
.initial-content { padding-top: 0 !important; }
.page__title { display: none !important; }

body { background: var(--bg); }

.three-sat-container {
  max-width: 1200px;
  margin: 0 auto;
  color: var(--text);
  padding: 20px 24px 40px;
}

.hero {
  background:
    radial-gradient(1200px 400px at 20% -10%, rgba(122,162,255,.12), transparent),
    radial-gradient(800px 300px at 90% 10%, rgba(155,222,172,.12), transparent);
  border: 1px solid var(--chip-border);
  background-color: var(--panel);
  border-radius: 16px;
  padding: 22px 20px;
  margin-bottom: 14px;
  box-shadow: var(--shadow);
}
.hero h2 { margin: 0 0 6px; letter-spacing: .2px; }
.hero p  { margin: 0; color: var(--muted); }

.status { margin: 8px 0 12px; font-size: .95rem; color: var(--muted); }
.status .ok    { color: var(--good); font-weight:600; }
.status .warn  { color: var(--bad);  font-weight:600; }
.status.pending { color: var(--warn); font-weight:600; }

.card {
  border: 1px solid var(--chip-border);
  border-radius: 16px;
  padding: 14px 16px;
  background: var(--panel);
  box-shadow: var(--shadow);
}

/* Sticky toolbar so controls stay visible while scrolling clauses */
.toolbar {
  position: sticky;
  top: 10px;
  z-index: 20;
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  margin-bottom: 10px;
  border: 1px solid var(--chip-border);
  border-radius: 12px;
  background: var(--panel);
  box-shadow: 0 6px 18px rgba(0,0,0,.06);
}
.input-inline{
  display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--chip-border);
  border-radius:10px; background:var(--chip); color:var(--muted);
}
.input-inline input[type="range"]{ width: 180px; }

button {
  appearance: none;
  border:1px solid var(--chip-border);
  background: linear-gradient(180deg, var(--panel), rgba(0,0,0,.02));
  color: var(--text);
  padding: 8px 12px;
  border-radius: 10px;
  font-weight:600;
  letter-spacing:.2px;
  transition: transform .05s ease, box-shadow .2s ease, border-color .2s ease;
  box-shadow: 0 2px 0 rgba(0,0,0,.10);
}
button:hover { border-color: var(--ring); box-shadow: 0 4px 16px rgba(0,0,0,.12), 0 0 0 4px var(--ring); }
button:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,.15); }
.btn-ghost  { background: transparent; }

/* Editor panel (hidden by default) */
.controls.hidden{ display:none; }
.controls{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin: 10px 0 8px;
}
.controls textarea{
  width: 100%;
  min-height: 140px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size: .9rem; line-height: 1.35; color: var(--text);
  background: var(--panel);
  border: 1px solid var(--chip-border); border-radius: 12px; padding: 10px 12px;
  outline: none; box-shadow: inset 0 0 0 2px transparent;
}
.controls textarea:focus { box-shadow: inset 0 0 0 2px var(--ring); }
.field label{ font-weight:600; margin-bottom:6px; color: var(--muted); }

/* Clauses & assignments */
.viz .section-title{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
.progress{
  height: 6px; background: var(--chip); border: 1px solid var(--chip-border);
  border-radius: 999px; overflow: hidden;
}
.progress > div{ height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); width:0%; transition: width .35s ease; }

/* Responsive grid; grows/shrinks with width nicely */
.clauses{
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 8px;
  margin-top: 8px;
  max-height: 360px;
  overflow: auto;
  padding-right: 4px;
}

/* thinner nice scrollbars */
.clauses::-webkit-scrollbar{ height: 8px; width: 8px; }
.clauses::-webkit-scrollbar-thumb{ background: #c7cfec55; border-radius: 10px; }
@media (prefers-color-scheme: dark){
  .clauses::-webkit-scrollbar-thumb{ background: #ffffff33; }
}

.clause{
  padding: 8px 10px;
  border-radius: 12px;
  border: 1px solid var(--chip-border);
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background: var(--chip);
  position: relative;
  font-size: .9rem;
  line-height: 1.25;
  word-break: break-word;
}
.clause .dot{
  position:absolute; top:10px; right:10px; width:10px; height:10px; border-radius:50%;
  box-shadow: 0 0 0 4px rgba(0,0,0,.04);
}
.clause.sat   { background: rgba(46,204,113,.10); border-color: rgba(46,204,113,.35); }
.clause.sat .dot{ background: var(--good); }
.clause.unsat { background: rgba(255,107,107,.10); border-color: rgba(255,107,107,.35); }
.clause.unsat .dot{ background: var(--bad); }
.clause.selected { font-weight:700; border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring), 0 6px 16px rgba(0,0,0,.12); }

.assignments{
  margin-top: 10px;
}
.assignments table{
  width: 100%;
  border-collapse: separate;
  border-spacing: 6px;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  font-size:.9rem;
}
.assignments td{
  padding: 4px 10px;
  border: 1px solid var(--chip-border);
  border-radius: 8px;
  background: var(--chip);
  white-space: nowrap;
  text-align: center;
}
.assignments td.highlighted{
  border: 2px solid var(--accent);
  box-shadow: 0 0 0 2px var(--ring);
}
.assignments td.comparison{
  border: none;
  background: transparent;
  font-size: 1.2rem;
  padding: 2px;
}
.assignments td.comparison.highlighted{
  box-shadow: none;
}
.assignments .label-row td{
  border: none;
  background: transparent;
  font-weight: 600;
  color: var(--muted);
  text-align: left;
  padding: 8px 6px 4px;
}
.assignment .status-dot{ width:8px; height:8px; border-radius:50%; box-shadow: 0 0 0 3px rgba(0,0,0,.04); border: 1px solid rgba(0,0,0,.1); }
.assignment .status-dot.match{ background: #2ecc71; }
.assignment .status-dot.mismatch{ background: #ff6b6b; }

/* Chain */
.chain { margin-top: 10px; }
.chain svg { width: 100%; height: 160px; }
.legend { font-size: .9rem; color: var(--muted); margin-top: 6px; }
.chain .section-title { margin-bottom: 6px; }

.kbd{
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
  background: var(--chip);
  border: 1px solid var(--chip-border);
  padding: 2px 6px;
  border-radius: 6px;
}

.footer-note{
  margin-top: 18px; padding: 14px 16px; border-left: 4px solid var(--accent);
  background: linear-gradient(90deg, rgba(122,162,255,.06), transparent);
  border-radius: 12px; color: var(--muted);
}
</style>

<div class="three-sat-container">
  <div class="hero">
    <h2>Random Walk for 3SAT</h2>
    <p>This demo shows Schöning's algorithm that can solve 3-SAT in expected time O(1.34<sup>n</sup>). We will show O(1.74<sup>n</sup>) in the class. At each step: pick a uniformly random variable from an arbitrary unsatisfied clause. Track the Hamming agreement with a fixed satisfying assignment, visualized as a 1-D Markov chain on states <span class="kbd">0..n</span>.</p>
  </div>

  <!-- Sticky toolbar -->
  <div class="toolbar">
    <button id="btnStep">Step</button>
    <button id="btnPlay">Play</button>
    <button id="btnRestart" class="btn-ghost">Restart random</button>
    <button id="btnToggleControls" class="btn-ghost" title="Show/Hide instance editor">Change instance</button>
    <span class="input-inline">Speed <input id="speedInput" type="range" min="40" max="1000" step="20" value="240"></span>
  </div>

  <div class="status" id="status"></div>

  <!-- Hidden editor (opens over the toolbar) -->
  <div class="controls hidden card" id="editorPanel">
    <div class="field">
      <label for="cnfInput">DIMACS CNF <span class="small">(≤ 20 variables)</span></label>
      <textarea id="cnfInput"></textarea>
    </div>
    <div class="field">
      <label for="fixedInput">Fixed satisfying assignment <span class="small">(0/1 or ±1, space-separated). Leave empty to auto-solve.</span></label>
      <textarea id="fixedInput" placeholder="e.g. 1 0 1 1 0"></textarea>
    </div>
    <div style="grid-column: 1 / -1; display:flex; justify-content:flex-end; gap:8px;">
      <button id="btnDone" class="btn-ghost">Done</button>
    </div>
  </div>

  <div class="card viz">
    <div class="section-title">
      <div><strong>Clauses</strong></div>
    </div>
    <div class="clauses" id="clauses"></div>
    <div class="assignments" id="assignments"></div>
  </div>

  <div class="card viz chain">
    <div class="section-title">
      <div><strong>Agreement with fixed assignment</strong> <span class="small">nodes 0..n</span></div>
      <div class="small" id="probLabel"></div>
    </div>
    <svg id="chainSvg" viewBox="0 0 1000 180" preserveAspectRatio="xMidYMid meet" aria-label="Hamming agreement chain"></svg>
    <div class="legend">After selecting a clause that we don't satisfy, we move towards the fixed solution with probability at least <span class="kbd">1/3</span>.</div>
  </div>

  <div class="footer-note">
    <strong>Context.</strong> This walk is the core move used in local-search SAT solvers (e.g. WalkSAT) and also appears in theoretical algorithms. A classic example is <em>Schöning’s algorithm</em> for 3-SAT. Learn more: <a href="https://en.wikipedia.org/wiki/Sch%C3%B6ning%27s_algorithm">Schöning’s algorithm</a> · <a href="https://en.wikipedia.org/wiki/Boolean_satisfiability_problem">Boolean satisfiability problem</a>.
  </div>
</div>

<script>
/* —— JS unchanged except for toolbar/editor hooks & a tiny serialize helper —— */

/* Utilities */
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return ((t^t>>>14)>>>0)/4294967296}}
function hashStringToSeed(str){let h=2166136261>>>0;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619)}return h>>>0}

/* DIMACS + eval */
function parseDimacs(text){
  const lines = text.split(/\r?\n/); const clauses=[]; let declaredN=null, declaredM=null;
  for (const raw of lines){
    const line=raw.trim(); if(!line||line.startsWith('c')) continue;
    if(line.startsWith('p')){ const p=line.split(/\s+/); if(p.length>=4 && p[1].toLowerCase()==='cnf'){declaredN=+p[2]; declaredM=+p[3];} continue; }
    const nums=line.split(/\s+/).map(x=>parseInt(x,10)).filter(x=>!Number.isNaN(x)); let clause=[];
    for(const v of nums){ if(v===0) break; clause.push(v); }
    if(clause.length>0) clauses.push(clause);
  }
  let n=0; for(const c of clauses) for(const lit of c) n=Math.max(n,Math.abs(lit));
  if(declaredN!==null) n=Math.max(n,declaredN);
  return { n, clauses };
}
function evalClause(clause,a){ for(const lit of clause){ const i=Math.abs(lit)-1, pos=lit>0, v=a[i]; if((pos&&v)||(!pos&&!v)) return true; } return false; }
function evalFormula(clauses,a){ return clauses.every(c=>evalClause(c,a)); }

/* Tiny solver (n ≤ 20) */
function solveSAT(n,clauses){
  const a=new Array(n).fill(false);
  function dfs(i){
    if(i===n) return evalFormula(clauses,a)?a.slice():null;
    for(let b=0;b<2;b++){
      a[i]=!!b; let ok=true;
      for(const cl of clauses){
        let can=true; let some=false;
        for(const lit of cl){
          const idx=Math.abs(lit)-1, pos=lit>0;
          if(idx>i){ some=true; can=true; break; }
          if((pos&&a[idx])||(!pos&&!a[idx])){ some=true; can=true; break; }
        }
        if(!can){ ok=false; break; }
      }
      if(ok){ const r=dfs(i+1); if(r) return r; }
    }
    return null;
  }
  return dfs(0);
}
function parseFixedAssignment(text,n){
  if(!text||!text.trim()) return null;
  const t=text.trim().split(/\s+/); if(t.length<n) return null;
  const arr=[]; for(let i=0;i<n;i++){ const s=t[i];
    if(s==='1'||s==='+1'||s==='+') arr.push(true);
    else if(s==='0'||s==='-1'||s==='-') arr.push(false);
    else return null;
  } return arr;
}
function serializeCNF(n,clauses){ let out=`c Current instance\np cnf ${n} ${clauses.length}\n`; for(const cl of clauses){ out+=`${cl.join(' ')} 0\n`; } return out; }

/* DOM */
const elCNF=document.getElementById('cnfInput');
const elFixed=document.getElementById('fixedInput');
const elStatus=document.getElementById('status');
const elClauses=document.getElementById('clauses');
const elAssignments=document.getElementById('assignments');
const elProb=document.getElementById('probLabel');
const svg=document.getElementById('chainSvg');
const elProg=document.getElementById('satProgress');

const btnStep=document.getElementById('btnStep');
const btnPlay=document.getElementById('btnPlay');
const btnRestart=document.getElementById('btnRestart');
const btnToggleControls=document.getElementById('btnToggleControls');
const editorPanel=document.getElementById('editorPanel');
const elSpeed=document.getElementById('speedInput');
const btnDone=document.getElementById('btnDone');

/* State */
let n=0, clauses=[], fixed=null, working=null;
let rng=Math.random, playing=false, timer=null, substep=0;
let selectedClauseIndex=-1, hammingAgree=0, stepCount=0;

/* Helpers */
function setStatus(html,ok){ elStatus.innerHTML=html; elStatus.className='status '+(ok===true?'ok':ok===false?'warn':''); }
function countAgree(a,b){ let h=0; for(let i=0;i<a.length;i++) if(a[i]===b[i]) h++; return h; }
function updateProgressBar(){
  if(!elProg) return; // Progress bar removed
  if(!working){ elProg.style.width='0%'; return; }
  const sat=clauses.reduce((s,c)=>s+(evalClause(c,working)?1:0),0);
  const pct=clauses.length?Math.round(100*sat/clauses.length):0;
  elProg.style.width=pct+'%'; elProg.title=`${sat}/${clauses.length} clauses satisfied`;
}
function renderAssignments(){
  elAssignments.innerHTML=''; if(!fixed||!working) return;

  // Get highlighted variable indices from selected clause
  const highlightedVars=new Set();
  if(selectedClauseIndex>=0 && selectedClauseIndex<clauses.length){
    for(const lit of clauses[selectedClauseIndex]){
      highlightedVars.add(Math.abs(lit)-1);
    }
  }

  const table=document.createElement('table');

  // Our solution heading row
  const headerRow1=document.createElement('tr'); headerRow1.className='label-row';
  const th1=document.createElement('td'); th1.colSpan=n; th1.textContent='↓ Our solution ↓';
  headerRow1.appendChild(th1); table.appendChild(headerRow1);

  // Our solution values row
  const ourRow=document.createElement('tr');
  for(let i=0;i<n;i++){
    const td=document.createElement('td');
    if(highlightedVars.has(i)) td.className='highlighted';
    td.innerHTML=`x${i} = <b>${working[i]?1:0}</b>`;
    ourRow.appendChild(td);
  }
  table.appendChild(ourRow);

  // Comparison row (checkmarks/crosses)
  const compRow=document.createElement('tr');
  for(let i=0;i<n;i++){
    const td=document.createElement('td');
    td.className='comparison'+(highlightedVars.has(i)?' highlighted':'');
    const isMatch=(working[i]===fixed[i]);
    td.textContent = isMatch ? '✓' : '✗';
    td.style.color = isMatch ? 'var(--good)' : 'var(--bad)';
    compRow.appendChild(td);
  }
  table.appendChild(compRow);

  // Fixed solution values row
  const fixedRow=document.createElement('tr');
  for(let i=0;i<n;i++){
    const td=document.createElement('td');
    if(highlightedVars.has(i)) td.className='highlighted';
    td.innerHTML=`x${i} = <b>${fixed[i]?1:0}</b>`;
    fixedRow.appendChild(td);
  }
  table.appendChild(fixedRow);

  // Fixed solution heading row (below)
  const headerRow2=document.createElement('tr'); headerRow2.className='label-row';
  const th2=document.createElement('td'); th2.colSpan=n; th2.textContent='↑ Fixed correct solution ↑';
  headerRow2.appendChild(th2); table.appendChild(headerRow2);

  elAssignments.appendChild(table);
}
function renderClauses(){
  elClauses.innerHTML=''; const unsat=[];
  for(let i=0;i<clauses.length;i++){
    const sat=evalClause(clauses[i],working); if(!sat) unsat.push(i);
    const d=document.createElement('div');
    d.className='clause '+(sat?'sat':'unsat')+(i===selectedClauseIndex?' selected':'');
    d.textContent='(' + clauses[i].map(l=> l>0? `x${l-1}` : `¬x${-l-1}`).join(' ∨ ') + ')';
    elClauses.appendChild(d);
  }
  updateProgressBar(); return unsat;
}
function renderChain(){
  svg.innerHTML=''; if(!fixed) return;
  const width=svg.viewBox.baseVal.width, y=92, R=15, nodeCount=n+1, padX=40, usable=width-2*padX, stepX=nodeCount>1?usable/(nodeCount-1):0;

  const axis=document.createElementNS('http://www.w3.org/2000/svg','line');
  axis.setAttribute('x1',padX); axis.setAttribute('y1',y);
  axis.setAttribute('x2',width-padX); axis.setAttribute('y2',y);
  axis.setAttribute('stroke','#3a4561'); axis.setAttribute('stroke-width','2'); svg.appendChild(axis);

  for(let i=0;i<nodeCount;i++){
    const cx=padX+i*stepX;
    if(i<nodeCount-1){
      const seg=document.createElementNS('http://www.w3.org/2000/svg','line');
      seg.setAttribute('x1',cx+R); seg.setAttribute('y1',y);
      seg.setAttribute('x2',cx+stepX-R); seg.setAttribute('y2',y);
      seg.setAttribute('stroke','#3a4561'); seg.setAttribute('stroke-width','2'); svg.appendChild(seg);
    }
    const g=document.createElementNS('http://www.w3.org/2000/svg','g');
    const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
    circle.setAttribute('cx',cx); circle.setAttribute('cy',y); circle.setAttribute('r',R);
    circle.setAttribute('fill', i===hammingAgree ? 'url(#gradActive)' : '#1b2233');
    circle.setAttribute('stroke', i===hammingAgree ? '#89a7ff' : '#2a3347');
    circle.setAttribute('stroke-width', i===hammingAgree ? '2.5' : '1.5'); g.appendChild(circle);

    const label=document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('x',cx); label.setAttribute('y',y+34);
    label.setAttribute('text-anchor','middle'); label.setAttribute('font-size','12');
    label.setAttribute('fill','#8b93a7'); label.textContent=i; g.appendChild(label);
    svg.appendChild(g);
  }
  const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
  const grad=document.createElementNS('http://www.w3.org/2000/svg','linearGradient');
  grad.setAttribute('id','gradActive'); grad.setAttribute('x1','0'); grad.setAttribute('x2','1');
  const s1=document.createElementNS('http://www.w3.org/2000/svg','stop'); s1.setAttribute('offset','0%'); s1.setAttribute('stop-color','#7aa2ff');
  const s2=document.createElementNS('http://www.w3.org/2000/svg','stop'); s2.setAttribute('offset','100%'); s2.setAttribute('stop-color','#9bdeac');
  grad.appendChild(s1); grad.appendChild(s2); defs.appendChild(grad); svg.appendChild(defs);

  const marker=document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','arrowHead'); marker.setAttribute('markerWidth','14'); marker.setAttribute('markerHeight','10');
  marker.setAttribute('refX','10'); marker.setAttribute('refY','5'); marker.setAttribute('orient','auto'); marker.setAttribute('markerUnits','strokeWidth');
  const path=document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d','M0,0 L10,5 L0,10 Z'); path.setAttribute('fill','#2c6dff');
  marker.appendChild(path); defs.appendChild(marker);
}
function updateProbLabel(k){
  const existing=svg.querySelector('#probArrows'); if(existing) existing.remove();
  if(k==null||!fixed){ elProb.textContent=''; return; }
  elProb.textContent='';
  const width=svg.viewBox.baseVal.width, padX=40, y=92, R=15, nodeCount=n+1, usable=width-2*padX, stepX=nodeCount>1?usable/(nodeCount-1):0;
  const g=document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('id','probArrows');
  const arrowY=y-40, labelY=arrowY-12, color='#2c6dff';
  if(hammingAgree>0){
    const x1=padX+(hammingAgree-1)*stepX+R, x2=padX+hammingAgree*stepX-R, mid=(x1+x2)/2;
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',mid+30); line.setAttribute('y1',arrowY); line.setAttribute('x2',mid-30); line.setAttribute('y2',arrowY);
    line.setAttribute('stroke',color); line.setAttribute('stroke-width','3'); line.setAttribute('marker-end','url(#arrowHead)'); g.appendChild(line);
    const text=document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('x',mid); text.setAttribute('y',labelY);
    text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','16'); text.setAttribute('fill',color); text.textContent=`${k}/3`; g.appendChild(text);
  }
  if(hammingAgree<n){
    const x1=padX+hammingAgree*stepX+R, x2=padX+(hammingAgree+1)*stepX-R, mid=(x1+x2)/2;
    const line=document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',mid-30); line.setAttribute('y1',arrowY); line.setAttribute('x2',mid+30); line.setAttribute('y2',arrowY);
    line.setAttribute('stroke',color); line.setAttribute('stroke-width','3'); line.setAttribute('marker-end','url(#arrowHead)'); g.appendChild(line);
    const text=document.createElementNS('http://www.w3.org/2000/svg','text'); text.setAttribute('x',mid); text.setAttribute('y',labelY);
    text.setAttribute('text-anchor','middle'); text.setAttribute('font-size','16'); text.setAttribute('fill',color); text.textContent=`${3-k}/3`; g.appendChild(text);
  }
  svg.appendChild(g);
}

/* Walk mechanics */
function selectUnsatisfiedClause(){ for(let i=0;i<clauses.length;i++) if(!evalClause(clauses[i],working)) return i; return -1; }
function substepSelectClause(){
  selectedClauseIndex=selectUnsatisfiedClause();
  if(selectedClauseIndex===-1){ setStatus('<span class="ok">All clauses satisfied — solution reached.</span>', true); playing=false; btnPlay.textContent='Play'; updateProbLabel(null); return; }
  const clause=clauses[selectedClauseIndex]; let k=0; for(const lit of clause){ const idx=Math.abs(lit)-1; if(working[idx]===fixed[idx]) k++; }
  updateProbLabel(k); renderClauses(); renderAssignments();
}
function substepFlipVariable(){
  if(selectedClauseIndex<0) return;
  const clause=clauses[selectedClauseIndex]; const pick=clause[Math.floor(Math.random()*clause.length)]; const v=Math.abs(pick)-1;
  const before=(working[v]===fixed[v]); working[v]=!working[v]; const after=(working[v]===fixed[v]);
  if(before&&!after) hammingAgree--; else if(!before&&after) hammingAgree++; stepCount++; selectedClauseIndex=-1; updateProbLabel(null);
  renderClauses(); renderAssignments(); renderChain();
}
function doStep(){ if(substep===0){ substepSelectClause(); substep=1; } else { substepFlipVariable(); substep=0; } }
function restartWorkingAssignment(randomize=true){
  if(!fixed) return; working = randomize ? new Array(n).fill(false).map(()=>Math.random()<.5) : fixed.slice();
  hammingAgree=countAgree(working,fixed); substep=0; selectedClauseIndex=-1; stepCount=0;
  renderAssignments(); renderClauses(); renderChain();
  setStatus(`variables = ${n}, clauses = ${clauses.length}`, true);
}
function loadInstance(){
  const parsed=parseDimacs(elCNF.value); n=parsed.n; clauses=parsed.clauses;
  if(n<=0||n>20){ setStatus('<span class="warn">Invalid or too large instance. Require 1 ≤ n ≤ 20.</span>', false); return; }
  const manual=parseFixedAssignment(elFixed.value,n);
  if(manual && evalFormula(clauses,manual)) fixed=manual; else fixed=solveSAT(n,clauses);
  if(!fixed){ setStatus('<span class="warn">Instance appears UNSAT for n ≤ 20 (no satisfying assignment found).</span>', false);
    fixed=null; working=null; renderClauses(); renderAssignments(); renderChain(); return; }
  restartWorkingAssignment(true); updateProgressBar();
}
function playLoop(){ if(!playing) return; doStep(); const delay=parseInt(elSpeed.value,10)||240; timer=setTimeout(playLoop,delay); }

/* Events */
document.getElementById('btnDone').addEventListener('click', ()=>{ loadInstance(); editorPanel.classList.add('hidden'); });
btnStep.addEventListener('click', doStep);
btnPlay.addEventListener('click', ()=>{ if(!fixed) return; playing=!playing; btnPlay.textContent=playing?'Pause':'Play'; if(playing) playLoop(); });
btnRestart.addEventListener('click', ()=>{ restartWorkingAssignment(true); });
btnToggleControls.addEventListener('click', ()=>{
  if(editorPanel.classList.contains('hidden')){ elCNF.value=serializeCNF(n,clauses); elFixed.value=fixed?fixed.map(v=>v?'1':'0').join(' '):''; }
  editorPanel.classList.toggle('hidden');
});

/* Default instance: use a small random satisfiable CNF so the demo loads nicely */
(function init(){
  const n0=10, m0=40, fixed0=new Array(n0).fill(false).map(()=>Math.random()<0.5);
  const cls=[];
  const pickTriple=()=>{ const pool=[...Array(n0).keys()]; for(let i=pool.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [pool[i],pool[j]]=[pool[j],pool[i]]; } return pool.slice(0,3).sort((a,b)=>a-b); };
  for(let c=0;c<m0;c++){ const idxs=pickTriple(); let lits=idxs.map(i=> (Math.random()<0.5 ? (i+1) : -(i+1)));
    const sat=lit=>{ const vi=Math.abs(lit)-1; return (lit>0? fixed0[vi]: !fixed0[vi]); };
    if(!lits.some(sat)){ const k=(Math.random()*3)|0; lits[k]=-lits[k]; } cls.push(lits); }
  let txt=`c Random satisfiable 3-CNF\np cnf ${n0} ${m0}\n`; for(const cl of cls){ txt+=`${cl[0]} ${cl[1]} ${cl[2]} 0\n`; }
  elCNF.value=txt; elFixed.value=''; loadInstance();
})();
</script>
